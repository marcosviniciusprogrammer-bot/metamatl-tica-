<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metamatl√©tica ‚Äî Jogo da Mem√≥ria v3.12</title>
  <style>
    :root{
      --bg: #060917; --bg2:#0a1030; --panel:#0c1331; --card:#0e163c;
      --muted:#a7b0c7; --text:#f2f6ff; --accent:#7aa2ff;
      --radius:24px; --shadow:0 18px 50px rgba(0,0,0,.55)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1000px 700px at 5% -10%, #20307a55, transparent),
        radial-gradient(900px 700px at 110% -10%, #0f1f6a66, transparent),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:22px
    }
    .app{ width:min(1150px,100%)}
    .glass{ background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(12px);
      border-radius:var(--radius); box-shadow:var(--shadow); animation: fadeIn .8s ease
    }
    @keyframes fadeIn{from{opacity:0; transform:translateY(20px)}to{opacity:1; transform:translateY(0)}}
    .wrap{ padding:20px }
    header{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px; margin-bottom:14px }
    h1{ margin:0; font-size:clamp(24px,5vw,44px); letter-spacing:.4px; text-shadow:0 0 10px rgba(122,162,255,.6)}
    .tag{ background:rgba(122,162,255,.15); border:1px solid rgba(122,162,255,.4); padding:6px 12px; border-radius:14px;
      font-weight:700; letter-spacing:.4px; color:#d9e4ff; box-shadow:0 0 12px rgba(122,162,255,.25) }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center }
    .col{ flex:1 1 280px }
    .btn{ background:rgba(20,28,80,.85); border:1px solid #2a3a7a; color:var(--text);
      padding:14px 16px; border-radius:16px; font-weight:800; letter-spacing:.3px; cursor:pointer;
      transition: .2s transform ease, .2s box-shadow ease }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(90,130,255,.35) }
    .btn:active{ transform:translateY(0) scale(.97) }
    .btn.primary{ background:linear-gradient(180deg, #9ec2ff, #5b86ff); color:#0a0f1e; border:none;
      box-shadow:0 0 16px rgba(91,134,255,.7) }
    .btn.ghost{ background:rgba(15,25,60,.65) }
    select{ width:100%; background:#0d163d; color:#fff; border:1px solid #2a355a;
      padding:12px 14px; border-radius:14px; font-weight:700 }
    label{ display:block; font-size:15px; color:var(--muted); margin:4px 2px 8px }
    .screen{ display:none } .screen.active{ display:block }

    /* Lobby */
    .hero{ display:grid; grid-template-columns: 1.3fr 1fr; gap:20px; align-items:center }
    .brand{
      padding:26px; border-radius:22px;
      background: radial-gradient(120% 120% at -10% -20%, rgba(122,162,255,.25), transparent),
                  linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.15);
      box-shadow: 0 30px 60px rgba(12,20,56,.45), inset 0 0 40px rgba(122,162,255,.15);
    }
    .brand h2{ margin:0 0 6px; font-size:clamp(22px,4vw,36px) }
    .brand p{ margin:0; color:var(--muted) }
    .settings{ padding:20px; border-radius:22px; background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.15) }
    .chk{ display:flex; align-items:center; gap:10px; margin-top:12px; color:var(--muted); font-weight:700 }
    .chk input{ width:18px; height:18px }

    /* Board & cards */
    .board{ display:grid; gap:14px; padding:16px; border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow) }
    .cols-5{ grid-template-columns:repeat(5, 1fr)} .cols-6{ grid-template-columns:repeat(6, 1fr)}
    .gbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:12px }
    .stat{ background:rgba(12,20,56,.65); border:1px solid #243056; padding:10px 12px; border-radius:12px; font-size:14px }
    .tile{ position:relative; aspect-ratio:3/4; border:none; border-radius:20px; overflow:hidden; cursor:pointer;
      perspective:1000px; outline:none; box-shadow:0 10px 22px rgba(0,0,0,.4) }
    .tile-inner{ position:absolute; inset:0; transform-style:preserve-3d; transition:transform .5s cubic-bezier(.2,.8,.2,1) }
    .tile.flip .tile-inner{ transform:rotateY(180deg) }
    .face{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; border-radius:20px }
    .face.front{ background:radial-gradient(120% 120% at 20% 0%, #1d2a63, #101944 70%); border:1px solid #2f3e89 }
    .face.back{ transform:rotateY(180deg); border:1px solid rgba(255,255,255,.25);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)) }
    .dot{ width:60%; height:60%; border-radius:18px; box-shadow: inset 0 0 0 4px rgba(255,255,255,.22)}
    .emoji{ font-size: clamp(30px, 7vw, 54px) }
    .hint{ margin:8px 0 12px; color:#d6deff; font-weight:700; letter-spacing:.2px; text-shadow:0 0 6px rgba(122,162,255,.5) }

    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      backdrop-filter: blur(10px); background: rgba(6,10,24,.6) }
    .overlay.show{ display:flex }
    .win-card{ background:#0f162b; border:1px solid #2a355a; padding:28px; border-radius:20px; text-align:center; max-width:640px; box-shadow:var(--shadow) }
    .win-card h2{ margin:10px 0 } .win-card p{ margin:6px 0; color:var(--muted) }
    .win-title{ display:flex; align-items:center; justify-content:center; gap:10px; font-size:clamp(26px,4.5vw,36px); font-weight:800; letter-spacing:.3px }
    .crown{ font-size:1.2em; filter: drop-shadow(0 4px 8px rgba(0,0,0,.35)); }

    /* About */
    .about h3{ margin:14px 0 6px } .about p{ color:var(--muted); margin:6px 0 }
    .about ul{ margin:6px 0 12px 18px } .about li{ margin:6px 0 }
  </style>
</head>
<body>
  <div class="app">
    <header class="wrap">
      <div>
        <h1>Metamatl√©tica ‚Äî <span class="muted">Jogo da Mem√≥ria</span></h1>
        <div class="muted">Pensamento Computacional e Design de Jogos</div>
      </div>
      <div class="tag">v3.12</div>
    </header>

    <!-- LOBBY -->
    <section id="screen-lobby" class="screen active">
      <div class="wrap glass">
        <div class="hero">
          <div class="brand">
            <h2>üéÆ Metamatl√©tica</h2>
            <p>Escolha o tamanho e o tema, depois clique em <b>Jogar</b>. M√∫sica relaxante rola no fundo üòâ</p>
            <div class="row" style="margin-top:10px">
              <button id="btnAbout" class="btn ghost">‚ÑπÔ∏è O que √© Pensamento Computacional & Design de Jogos?</button>
            </div>
          </div>
          <div class="settings">
            <div class="row">
              <div class="col">
                <label>Tamanho</label>
                <select id="deckSize">
                  <option value="20">20 cartas (5 √ó 4)</option>
                  <option value="30">30 cartas (6 √ó 5)</option>
                </select>
              </div>
              <div class="col">
                <label>Tema</label>
                <select id="theme">
                  <option value="cores">Cores</option>
                  <option value="frutas">Frutas</option>
                </select>
              </div>
            </div>
            <label class="chk"><input type="checkbox" id="cbPreview"> Mostrar pr√©via de 10s antes de come√ßar</label>
            <div class="row" style="margin-top:12px">
              <button id="btnPlay" class="btn primary">üöÄ Jogar</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="screen-about" class="screen">
      <div class="wrap glass about">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:8px 0">‚ÑπÔ∏è Pensamento Computacional, Design de Jogos e Matem√°tica</h2>
          <button class="btn" id="btnBackLobby1">‚Üê Voltar ao Lobby</button>
        </div>
        <h3>Pensamento Computacional</h3>
        <ul>
          <li><b>Decomposi√ß√£o:</b> lobby, tabuleiro, turnos, vit√≥ria.</li>
          <li><b>Padr√µes:</b> pares iguais; layouts 5√ó4/6√ó5.</li>
          <li><b>Abstra√ß√£o:</b> representar cartas (tipo, valor, estado).</li>
          <li><b>Algoritmos:</b> embaralhar (Fisher‚ÄìYates), comparar, contar jogadas/pares/tempo.</li>
          <li><b>Teste & Depura√ß√£o:</b> consertar bugs (ex.: ‚Äú3 cartas viradas‚Äù).</li>
        </ul>
        <h3>Design de Jogos</h3>
        <ul>
          <li><b>Mec√¢nicas:</b> virar 2 cartas; se errar passa a vez; se acertar continua.</li>
          <li><b>Feedback:</b> anima√ß√µes + sons e m√∫sica de vit√≥ria.</li>
          <li><b>Dificuldade:</b> 20 ou 30 cartas; temas variados.</li>
          <li><b>UX:</b> textos-guia ‚ÄúEscolha uma carta‚Äù, etc.</li>
        </ul>
        <h3>Matem√°tica Envolvida</h3>
        <ul>
          <li><b>Contagem & Probabilidade:</b> chance de achar um par considerando cartas reveladas.</li>
          <li><b>Aritm√©tica:</b> jogadas, pares, tempo e taxa de acertos.</li>
          <li><b>Complexidade:</b> custo do shuffle e da checagem (O(n)).</li>
          <li><b>Geometria/Matrizes:</b> grade 5√ó4 ou 6√ó5; posi√ß√µes dos cards.</li>
        </ul>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="btnBackLobby2">‚Üê Voltar ao Lobby</button>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section id="screen-game" class="screen">
      <div class="wrap glass">
        <div class="gbar">
          <div class="row" style="gap:8px; align-items:center">
            <button class="btn" id="btnBackInGame">‚Üê Voltar ao Lobby</button>
            <div class="stat">‚è±Ô∏è <b id="time">00:00</b></div>
            <div class="stat">üÉè <b id="moves">0</b> jogadas</div>
            <div class="stat">‚úÖ <b id="pairs">0</b> pares</div>
            <button class="btn" id="btnRestart">Reiniciar</button>
          </div>
        </div>
        <div class="hint" id="hint">Escolha uma carta</div>
        <div id="board" class="board"></div>
      </div>
    </section>

    <!-- WIN -->
    <div class="overlay" id="overlayWin" aria-hidden="true">
      <div class="win-card">
        <h2 class="win-title"><span class="crown">üëë</span> Voc√™ venceu! <span class="crown">üëë</span></h2>
        <div class="row" style="justify-content:center; gap:10px; margin:10px 0 6px">
          <div class="stat">‚è±Ô∏è <b id="wTime">00:00</b></div>
          <div class="stat">‚úÖ <b id="wPairs">0</b> pares</div>
          <div class="stat">üéØ <b id="wMoves">0</b> jogadas</div>
        </div>
        <p class="muted" style="margin-top:6px">Parab√©ns pelo desempenho! Continue jogando üòâ</p>
        <div style="margin-top:10px">
          <button class="btn primary" id="btnPlayAgain">Jogar de novo</button>
          <button class="btn" id="btnBackFromWin">‚Üê Voltar ao Lobby</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  const $ = s=>document.querySelector(s);
  const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a };

  // flags
  const FP_KEY='mm_first_play'; if(localStorage.getItem(FP_KEY)===null) localStorage.setItem(FP_KEY,'true');
  const PV_KEY='mm_preview_always'; if(localStorage.getItem(PV_KEY)===null) localStorage.setItem(PV_KEY,'true');
  $('#cbPreview').checked = localStorage.getItem(PV_KEY)==='true';
  $('#cbPreview').onchange = ()=> localStorage.setItem(PV_KEY, $('#cbPreview').checked?'true':'false');

  // audio
  const AudioFX = {
    ctx:null, master:null, inited:false, lobbyOn:false, lobbyIv:null,
    init(){ if(this.inited) return; const AC=window.AudioContext||window.webkitAudioContext; this.ctx=new AC(); this.master=this.ctx.createGain(); this.master.gain.value=0.12; this.master.connect(this.ctx.destination); this.inited=true; },
    tone(freq=800,dur=.07,type='sine',gain=0.10){ if(!this.inited) return; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(this.master); const t=this.ctx.currentTime; o.start(t); g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.stop(t+dur); },
    startLobby(){ if(!this.inited||this.lobbyOn) return; this.lobbyOn=true; const chords=[[392,494,587],[440,554,659],[392,523,659],[349,440,587]]; let idx=0; this.lobbyIv=setInterval(()=>{ if(!this.lobbyOn) return; const c=chords[idx%chords.length]; c.forEach((f,i)=>this.tone(f,.7+i*0.12,'sine',.08)); idx++; }, 1100); },
    stopLobby(){ this.lobbyOn=false; if(this.lobbyIv){ clearInterval(this.lobbyIv); this.lobbyIv=null; } },
    flipOpen(){ this.tone(760,.07,'sine',.09) }, flipClose(){ this.tone(340,.09,'sine',.09) },
    match(){ this.tone(880,.08,'triangle',.11); setTimeout(()=>this.tone(1320,.09,'triangle',.11), 70); },
    victory(){ const n=[523,659,784,988,1046,1318,1567]; let t=0; n.forEach((f,i)=>{ setTimeout(()=>this.tone(f,0.14+i*0.03,'triangle',.12), t*1000); t+=0.17; }); setTimeout(()=>[523,659,784].forEach(ff=>this.tone(ff,.7,'sawtooth',.12)), (t+0.1)*1000); }
  };
  document.addEventListener('click', ()=>{ try{ if(!AudioFX.inited){ AudioFX.init(); AudioFX.ctx.resume(); AudioFX.startLobby(); } }catch(e){} }, {once:true});

  // deck/theme
  const PALETTE=['#ff7675','#74b9ff','#55efc4','#fdcb6e','#a29bfe','#ffeaa7','#81ecec','#fab1a0','#fd79a8','#00b894','#0984e3','#6c5ce7'];
  const FRUTAS=['üçé','üçå','üçá','üçì','üçç','üçë','üçâ','ü•ù','üçê','üçí'];
  function makeDeck(size, theme){
    const pairs = Math.floor(size/2); let items=[];
    if(theme==='cores'){ const colors=[...PALETTE]; while(colors.length<pairs){ const h=(colors.length*47)%360; colors.push(`hsl(${h} 80% 55%)`) } items=colors.slice(0,pairs).map(c=>({t:'cor',v:c})); }
    else { const fruits=[...FRUTAS]; while(fruits.length<pairs){ fruits.push('üçè','ü•≠','üçä')[fruits.length%3] } items=fruits.slice(0,pairs).map(e=>({t:'emoji',v:e})); }
    return shuffle([...items, ...items]).map((x,i)=>({id:i,key:x.v,t:x.t,matched:false}));
  }

  // state / screens
  const screens = { lobby: $('#screen-lobby'), game: $('#screen-game'), about: $('#screen-about') };
  function go(to){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[to].classList.add('active') }
  let G=null, timer=null, previewTimer=null, countdownTimer=null;

  function newGame(size, theme){
    const deck = makeDeck(size, theme);
    G = { size, theme, deck, first:null, second:null, lock:false, moves:0, pairs:0, sec:0 };
    $('#moves').textContent='0'; $('#pairs').textContent='0'; $('#time').textContent='00:00';
    buildBoard();
    startTimer();
    go('game');

    // PR√âVIA: s√≥ se o checkbox estiver marcado
    if($('#cbPreview').checked){
      startPreview(10);
    }else{
      $('#hint').textContent='Escolha uma carta';
    }
  }

  function buildBoard(){
    const b = $('#board'); b.innerHTML=''; b.className='board ' + (G.size==20? 'cols-5':'cols-6');
    G.deck.forEach((c,i)=>{
      const el=document.createElement('button'); el.className='tile'; el.dataset.i=i;
      const inner=document.createElement('div'); inner.className='tile-inner';
      const front=document.createElement('div'); front.className='face front';
      const back=document.createElement('div'); back.className='face back';
      if(c.t==='cor'){ const dot=document.createElement('div'); dot.className='dot'; dot.style.background=c.key; back.appendChild(dot); }
      else { const em=document.createElement('div'); em.className='emoji'; em.textContent=c.key; back.appendChild(em); }
      inner.appendChild(front); inner.appendChild(back); el.appendChild(inner);
      el.addEventListener('click', ()=> flip(i));
      b.appendChild(el);
    });
  }

  function startTimer(){ if(timer) clearInterval(timer); timer=setInterval(()=>{ G.sec++; $('#time').textContent=fmtTime(G.sec); }, 1000) }
  function stopTimer(){ if(timer){ clearInterval(timer); timer=null } }
  function clearPreviewTimers(){ if(previewTimer){ clearTimeout(previewTimer); previewTimer=null } if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null } }

  function startPreview(seconds){
    G.lock = true;
    Array.from($('#board').children).forEach(t=>t.classList.add('flip'));
    let rem = seconds;
    $('#hint').textContent = `Memorize as cartas (${rem}s)`;
    countdownTimer = setInterval(()=>{
      rem--; $('#hint').textContent = `Memorize as cartas (${rem}s)`;
      if(rem<=0){ clearInterval(countdownTimer); countdownTimer=null; }
    }, 1000);
    previewTimer = setTimeout(()=>{
      Array.from($('#board').children).forEach(t=>t.classList.remove('flip'));
      G.lock = false;
      $('#hint').textContent = 'Escolha uma carta';
    }, seconds*1000);
  }

  function flip(i){
    if(G.lock || G.deck[i].matched || G.first===i) return;
    const tiles=$('#board').children;
    if(G.first==null){
      tiles[i].classList.add('flip'); AudioFX.flipOpen(); G.first=i; $('#hint').textContent='Agora outra carta'; return;
    }
    tiles[i].classList.add('flip'); AudioFX.flipOpen(); G.second=i; G.lock=true; G.moves++; $('#moves').textContent=G.moves;
    const a=G.deck[G.first], b=G.deck[G.second];
    if(a.key===b.key){
      a.matched=b.matched=true; G.pairs++; $('#pairs').textContent=G.pairs; AudioFX.match();
      setTimeout(()=>{ $('#hint').textContent='Continue jogando'; G.first=null; G.second=null; G.lock=false; if(G.pairs===Math.floor(G.size/2)) win(); }, 350);
    }else{
      setTimeout(()=>{ tiles[G.first].classList.remove('flip'); tiles[G.second].classList.remove('flip'); AudioFX.flipClose(); G.first=null; G.second=null; G.lock=false; $('#hint').textContent='Se errar, passa a vez'; }, 700);
    }
  }

  function win(){
    stopTimer(); AudioFX.victory();

    // Primeira vez: sem modal (mantido)
    const isFirstPlay = localStorage.getItem(FP_KEY)==='true';
    if(isFirstPlay){
      localStorage.setItem(FP_KEY,'false');
      setTimeout(()=>{ go('lobby'); AudioFX.startLobby(); }, 500);
      return;
    }

    // Estat√≠sticas na vit√≥ria
    $('#wTime').textContent  = fmtTime(G.sec);
    $('#wMoves').textContent = G.moves;
    $('#wPairs').textContent = G.pairs;

    $('#overlayWin').classList.add('show');
    $('#overlayWin').setAttribute('aria-hidden','false');
  }

  // events
  $('#btnPlay').onclick = ()=>{
    try{ if(!AudioFX.inited){ AudioFX.init(); AudioFX.ctx.resume(); } }catch(_){}
    AudioFX.stopLobby();
    newGame(+$('#deckSize').value, $('#theme').value);
  };
  $('#btnRestart').onclick = ()=>{ if(G){ clearPreviewTimers(); newGame(G.size, G.theme) } };
  $('#btnBackInGame').onclick = ()=>{ stopTimer(); clearPreviewTimers(); go('lobby'); AudioFX.startLobby(); };
  $('#btnBackFromWin').onclick = ()=>{ $('#overlayWin').classList.remove('show'); go('lobby'); AudioFX.startLobby(); };
  $('#btnPlayAgain').onclick = ()=>{ $('#overlayWin').classList.remove('show'); newGame(G.size, G.theme) };

  // About navigation
  $('#btnAbout').onclick = ()=> go('about');
  $('#btnBackLobby1').onclick = $('#btnBackLobby2').onclick = ()=> go('lobby');

  // start lobby music after first interaction (mobile)
  document.addEventListener('click', ()=>{ try{ if(!AudioFX.inited){ AudioFX.init(); AudioFX.ctx.resume(); AudioFX.startLobby(); } }catch(e){} }, {once:true});
  </script>
</body>
</html>
