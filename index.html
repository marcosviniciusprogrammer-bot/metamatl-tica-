<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MetamatlÃ©tica â€” jogo competitivo infantil</title>
<style>
:root{
  --bg:#060917;--bg2:#0a1030;--panel:#0c1331;--card:#0e163c;
  --muted:#a7b0c7;--text:#f2f6ff;--accent:#7aa2ff;
  --radius:24px;--shadow:0 18px 50px rgba(0,0,0,.55)
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(1000px 700px at 5% -10%, #20307a55, transparent),
    radial-gradient(900px 700px at 110% -10%, #0f1f6a66, transparent),
    linear-gradient(180deg, var(--bg), var(--bg2));
  color:var(--text);display:flex;align-items:center;justify-content:center;padding:20px
}
.app{width:min(1100px,100%)}
.glass{
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(12px);
  border-radius:var(--radius); box-shadow:var(--shadow); animation:fadeIn .6s ease
}
@keyframes fadeIn{from{opacity:.0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.wrap{padding:20px}
header{display:flex;justify-content:space-between;align-items:center;gap:14px;margin-bottom:14px;flex-wrap:wrap}
h1{margin:0;font-size:clamp(24px,4.8vw,42px);letter-spacing:.4px;text-shadow:0 0 10px rgba(122,162,255,.6)}
h1 small{display:block;font-weight:600;color:var(--muted);font-size: clamp(12px,2.8vw,16px)}
.tag{background:rgba(122,162,255,.15);border:1px solid rgba(122,162,255,.4);padding:6px 12px;border-radius:14px;font-weight:700;color:#d9e4ff}
.btn{
  background:rgba(20,28,80,.9);border:1px solid #2a3a7a;color:var(--text);
  padding:14px 16px;border-radius:16px;font-weight:800;letter-spacing:.3px;cursor:pointer;
  transition:.18s transform,.18s box-shadow
}
.btn:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(90,130,255,.35)}
.btn:active{transform:translateY(0) scale(.97)}
.btn.primary{background:linear-gradient(180deg,#9ec2ff,#5b86ff);color:#0a0f1e;border:none}
.btn.small{padding:10px 12px;border-radius:12px;font-weight:900}
.row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
.screen{display:none}.screen.active{display:block}

/* lobby card */
.hero{display:grid;grid-template-columns:1fr;gap:18px}
.brand{padding:22px;border-radius:22px;position:relative;overflow:hidden;
  background: radial-gradient(120% 120% at -10% -20%, rgba(122,162,255,.25), transparent),
              linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.15);box-shadow:0 30px 60px rgba(12,20,56,.45), inset 0 0 40px rgba(122,162,255,.15);
}
.brand h2{margin:0 0 6px;font-size:clamp(22px,4.4vw,36px)}
.brand p{margin:8px 0 0;color:var(--muted)}
.controls{padding:18px;border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.15)}
.vol{display:flex;align-items:center;gap:10px}
.slider{appearance:none;width:220px;max-width:60vw;height:8px;background:#2a3a7a;border-radius:999px;outline:none}
.slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;background:#7aa2ff;border-radius:50%;box-shadow:0 0 6px #7aa2ff;cursor:pointer}

/* game HUD */
.gbar{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.stat{background:rgba(12,20,56,.65);border:1px solid #243056;padding:10px 12px;border-radius:12px;font-size:14px}
.hint{margin:8px 0 12px;color:#d6deff;font-weight:800;letter-spacing:.2px;text-shadow:0 0 6px rgba(122,162,255,.5)}

/* board */
.board{display:grid;gap:12px;padding:16px;border-radius:22px;border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));box-shadow:var(--shadow)}
.cols-6{grid-template-columns:repeat(6,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
.tile{position:relative;aspect-ratio:3/4;border:none;border-radius:18px;overflow:hidden;cursor:pointer;perspective:1000px;outline:none;box-shadow:0 10px 22px rgba(0,0,0,.4)}
.tile-inner{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .45s cubic-bezier(.2,.8,.2,1)}
.tile.flip .tile-inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;border-radius:18px}
.face.front{background:radial-gradient(120% 120% at 20% 0%, #1d2a63, #101944 70%);border:1px solid #2f3e89}
.face.back{transform:rotateY(180deg);border:1px solid rgba(255,255,255,.25);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));font-size:clamp(28px,7vw,48px)}

/* event bar */
.eventBar{height:10px;border-radius:999px;background:#17204a;border:1px solid #2a3a7a;overflow:hidden}
.eventFill{height:100%;width:0%;background:linear-gradient(90deg,#6fa3ff,#9ec2ff);box-shadow:0 0 12px #6fa3ff inset;transition:width .2s linear}

/* event overlay */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,8,22,.65);backdrop-filter:blur(8px);z-index:50}
.overlay.show{display:flex}
.eventCard{background:#0f162b;border:1px solid #2a355a;border-radius:22px;padding:26px;max-width:560px;text-align:center;animation:pop .4s ease}
@keyframes pop{from{transform:scale(.94);opacity:.4}to{transform:scale(1);opacity:1}}
.eventTitle{font-size:clamp(22px,5vw,30px);font-weight:900;margin:0}
.eventDesc{color:var(--muted);margin:6px 0 0}

/* Effects for events */
#gameCard.blackout{filter:brightness(0.04) saturate(0);transition:filter .2s}
#gameCard.blackout::after{content:""; position:absolute; inset:0; border-radius:22px; background:rgba(0,0,0,.35); pointer-events:none}
#gameCard.inverted{transform:rotate(180deg);transition:transform .4s}
#gameCard.bw-mode{filter:grayscale(1) contrast(1.05) brightness(.92)}
.recolor .face.back {transition:background-color .25s}

.matched .face.front{visibility:hidden}
.matched .tile-inner{transform:rotateY(180deg)}

@media (max-width:760px){ .slider{width:100%} }
</style>
</head>
<body>
<div class="app">
  <header class="wrap">
    <div>
      <h1>MetamatlÃ©tica â€” jogo competitivo infantil
        <small>Frutas + emojis misturados. FaÃ§a o menor tempo! â±ï¸</small>
      </h1>
    </div>
    <div class="tag">v4.1</div>
  </header>

  <!-- LOBBY -->
  <section id="screen-lobby" class="screen active">
    <div class="wrap glass">
      <div class="hero">
        <div class="brand">
          <h2>ğŸ® Escolha o modo</h2>
          <p>ğŸ‘¶ <b>Modo CrianÃ§a</b> (4Ã—5, 10 pares) â€” um pouco mais fÃ¡cil.<br>ğŸš€ <b>Modo Normal</b> (6Ã—7, 21 pares) â€” com eventos.</p>
        </div>
        <div class="controls">
          <div class="row">
            <button id="btnPlayEasy" class="btn primary">ğŸ‘¶ Modo CrianÃ§a</button>
            <button id="btnPlay" class="btn">ğŸš€ Jogar (Normal)</button>
            <button id="btnToggleSound" class="btn">ğŸ”ˆ Som: ON</button>
            <div class="vol"><span>ğŸ”Š</span><input id="volumeSlider" class="slider" type="range" min="0" max="100" value="70"></div>
          </div>
          <div style="margin-top:12px">
            <div class="eventBar" title="PrÃ³ximo evento">
              <div id="lobbyEventFill" class="eventFill"></div>
            </div>
            <div class="muted" style="margin-top:6px;font-size:14px">Barra de evento (apenas visual no lobby)</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GAME -->
  <section id="screen-game" class="screen">
    <div class="wrap glass" id="gameCard">
      <div class="gbar">
        <div class="row">
          <button class="btn" id="btnBackInGame">â† Lobby</button>
          <div class="stat">â±ï¸ <b id="time">00:00</b></div>
          <div class="stat">ğŸƒ <b id="moves">0</b> jogadas</div>
          <div class="stat">âœ… <b id="pairs">0</b> pares</div>
          <div class="stat">ğŸ† <b id="score">0</b> pontos</div>
          <button class="btn small" id="btnReveal">ğŸ” Revelar cartas grÃ¡tis 5s</button>
        </div>
        <div class="row" id="gameSoundRow">
          <button class="btn" id="btnToggleSoundGame">ğŸ”ˆ Som: ON</button>
          <div class="vol"><span>ğŸ”Š</span><input id="volumeSliderGame" class="slider" type="range" min="0" max="100" value="70"></div>
        </div>
      </div>
      <div class="eventBar"><div id="gameEventFill" class="eventFill"></div></div>
      <div class="hint" id="hint">Boa sorte! ğŸ‘€</div>
      <div id="board" class="board"></div>
    </div>
  </section>

  <!-- EVENT OVERLAY -->
  <div id="eventOverlay" class="overlay" aria-hidden="true">
    <div class="eventCard">
      <h3 class="eventTitle" id="eventTitle">!</h3>
      <p class="eventDesc" id="eventDesc"></p>
      <div style="margin-top:10px"><button id="eventGo" class="btn primary">ComeÃ§ar!</button></div>
    </div>
  </div>

  <!-- WIN -->
  <div class="overlay" id="overlayWin" aria-hidden="true">
    <div class="eventCard">
      <h3 class="eventTitle">ğŸ‘‘ VocÃª venceu!</h3>
      <p class="eventDesc"><span id="wTime">00:00</span> â€¢ <span id="wMoves">0</span> jogadas â€¢ <span id="wPairs">0</span> pares â€¢ ğŸ† <span id="wScore">0</span> pts</p>
      <div style="margin-top:10px" class="row">
        <button class="btn primary" id="btnPlayAgain">Jogar de novo</button>
        <button class="btn" id="btnBackFromWin">â† Lobby</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= helpers ========= */
const $ = s => document.querySelector(s);
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const shuffle = a => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a }
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

/* ========= audio ========= */
const AudioFX = {
  ctx:null, master:null, inited:false, musicBus:null, sfxBus:null, vol:.7, soundOn:true,
  init(){
    if(this.inited) return;
    const AC=window.AudioContext||window.webkitAudioContext;
    this.ctx = new AC();
    this.master=this.ctx.createGain(); this.master.gain.value=this.vol;
    this.musicBus=this.ctx.createGain(); this.musicBus.gain.value=.45;
    this.sfxBus=this.ctx.createGain(); this.sfxBus.gain.value=1.0;
    this.musicBus.connect(this.master); this.sfxBus.connect(this.master); this.master.connect(this.ctx.destination);
    this.inited=true; this._startMusic();
  },
  setVolume(v){ this.vol=v; if(this.master) this.master.gain.value=this.soundOn? v : 0 },
  toggleSound(){ this.soundOn=!this.soundOn; if(this.master) this.master.gain.value=this.soundOn? this.vol : 0; syncSoundButtons(); },
  click(){ if(!this.inited) return; const t=this.ctx.currentTime;
    const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type='triangle'; o.frequency.value=700; g.gain.value=.17;
    o.connect(g); g.connect(this.sfxBus); o.start(t);
    o.frequency.exponentialRampToValueAtTime(1200,t+.05); g.gain.exponentialRampToValueAtTime(0.0001,t+.08); o.stop(t+.09);
  },
  tone(freq=800,dur=.07,type='sine',gain=.1){
    if(!this.inited) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(this.sfxBus);
    const t=this.ctx.currentTime; o.start(t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.stop(t+dur);
  },
  flipOpen(){ this.tone(760,.07,'sine',.12) }, flipClose(){ this.tone(340,.09,'sine',.12) },
  match(){ this.tone(880,.08,'triangle',.14); setTimeout(()=>this.tone(1320,.09,'triangle',.14), 70); },
  victory(){ [523,659,784,988,1046,1318,1567].forEach((f,i)=>setTimeout(()=>this.tone(f,.15,'triangle',.15),170*i)); },
  _startMusic(){ const chords=[[196,247,294],[220,277,330],[174,220,294],[196,247,330]]; let k=0;
    const loop=()=>{ if(!this.inited) return;
      const now=this.ctx.currentTime, ch=chords[k%chords.length];
      ch.forEach((f,i)=>{const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type='sine'; o.frequency.value=f; g.gain.value=.0001; o.connect(g); g.connect(this.musicBus);
        o.start(now); g.gain.linearRampToValueAtTime(.18/(i+1), now+.25+i*.06); g.gain.exponentialRampToValueAtTime(0.0001, now+5.3); o.stop(now+5.5);
      }); k++; setTimeout(loop, 5200);
    }; loop();
  }
};
function syncSoundButtons(){
  const t = AudioFX.soundOn ? 'ğŸ”ˆ Som: ON' : 'ğŸ”‡ Som: OFF';
  if($('#btnToggleSound')) $('#btnToggleSound').textContent=t;
  if($('#btnToggleSoundGame')) $('#btnToggleSoundGame').textContent=t;
  const v = Math.round(AudioFX.vol*100);
  if($('#volumeSlider')) $('#volumeSlider').value=v;
  if($('#volumeSliderGame')) $('#volumeSliderGame').value=v;
}

/* ========= regras ========= */
const RULES = {
  previewSeconds: 12,
  bonusRevealSeconds: 5,
  bonusCoverage: .30,
  events: [
    {key:'reveal_partial',    weight:35, duration:7},
    {key:'shuffle_unmatched', weight:30, duration:0},
    {key:'blackout',          weight:15, duration:4.5},
    {key:'invert_board',      weight:10, duration:14},
    {key:'recolor_board',     weight:10, duration:6}
  ],
  eventMin: 50, eventMax: 80, jitter: 10, cooldown: 55, maxPerGame: 4
};
const RULES_EASY = {
  previewSeconds: 10, bonusRevealSeconds: 5, bonusCoverage: .40,
  events: [], maxPerGame: 0
};

/* ========= pool ========= */
const POOL = ['ğŸ','ğŸŒ','ğŸ‡','ğŸ“','ğŸ','ğŸ‘','ğŸ‰','ğŸ¥','ğŸ','ğŸ’','ğŸŠ','ğŸˆ','ğŸ‹','ğŸ','ğŸ¥¥','ğŸ¥­','â­','ğŸŒ™','âš¡','ğŸ”¥','â„ï¸','ğŸŒˆ','ğŸ’','ğŸˆ','ğŸ²','ğŸ¯','ğŸµ','ğŸ›¸','ğŸ§©','ğŸš€','ğŸ§ ','ğŸª','ğŸ§¸','ğŸ','ğŸ€','ğŸ®','ğŸ§','âš½','ğŸ€','ğŸ¹','ğŸª','ğŸ¦„','ğŸ±'];
function sampleUnique(arr,n){ const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a.slice(0,n); }
function makeDeck(pairs){
  const items = sampleUnique(POOL, pairs).map(v=>({t:'emoji',v}));
  return shuffle([...items, ...items]).map((x,i)=>({id:i,key:x.v,t:x.t,matched:false}));
}

/* ========= state ========= */
let G = null, timer=null;
let eventTimer=null, eventTargetSec=0, eventElapsed=0, lastEvent='', eventsFired=0;
function totalPairs(){ return (G?.deck?.length||0)/2 }
function setHint(msg){ $('#hint').textContent = msg; }
function updateScore(){
  const pts = Math.max(0, Math.floor(G.pairs*120 - G.moves*3 - G.sec));
  G.score = pts; $('#score').textContent = pts;
}

/* ========= UI ========= */
function buildBoard(){
  const b=$('#board'); b.innerHTML='';
  b.classList.remove('cols-4','cols-6');
  b.classList.add(G.mode==='easy' ? 'cols-4' : 'cols-6');
  G.deck.forEach((c,i)=>{
    const el=document.createElement('button'); el.className='tile'+(c.matched?' matched':''); el.dataset.i=i;
    const inner=document.createElement('div'); inner.className='tile-inner';
    const front=document.createElement('div'); front.className='face front';
    const back=document.createElement('div'); back.className='face back';
    back.textContent=c.key;
    inner.appendChild(front); inner.appendChild(back); el.appendChild(inner);
    el.addEventListener('click',()=>flip(i));
    b.appendChild(el);
  });
}
function startTimer(){ if(timer) clearInterval(timer); timer=setInterval(()=>{ G.sec++; $('#time').textContent=fmtTime(G.sec); updateScore(); },1000); }
function stopTimer(){ if(timer){clearInterval(timer); timer=null} }

/* ========= preview ========= */
function preview(seconds){
  G.lock=true; [...$('#board').children].forEach(t=>t.classList.add('flip')); setHint('Boa sorte! ğŸ‘€');
  setTimeout(()=>{ [...$('#board').children].forEach(t=>t.classList.remove('flip')); G.lock=false; setHint('Escolha uma carta ğŸ‘€'); }, seconds*1000);
}

/* ========= game start/stop ========= */
function newGame(mode='normal'){
  $('#btnPlay').style.display='none'; $('#btnPlayEasy').style.display='none';
  $('#btnToggleSound').style.display='none'; $('#volumeSlider').closest('.vol').style.display='none';
  go('game');

  G = {
    mode,
    deck: makeDeck(mode==='easy' ? 10 : 21), // 10 pares (4x5) ou 21 pares (6x7)
    first:null, second:null, lock:false, moves:0, pairs:0, sec:0, fastFlip:false, score:0, revealUsed:false
  };
  $('#moves').textContent='0'; $('#pairs').textContent='0'; $('#time').textContent='00:00'; $('#score').textContent='0';
  buildBoard(); startTimer(); preview((mode==='easy'? RULES_EASY : RULES).previewSeconds);
  $('#btnReveal').disabled=false; $('#btnReveal').textContent='ğŸ” Revelar cartas grÃ¡tis 5s';

  eventsFired=0; lastEvent='';
  if(mode==='normal'){ scheduleNextEvent(true); } else { $('#gameEventFill').style.width='0%'; stopEventLoop(); }
}
function backToLobby(){
  stopTimer(); stopEventLoop();
  $('#btnPlay').style.display='inline-block'; $('#btnPlayEasy').style.display='inline-block';
  $('#btnToggleSound').style.display='inline-block'; $('#volumeSlider').closest('.vol').style.display='flex';
  go('lobby'); $('#lobbyEventFill').style.width='0%';
}

/* ========= flips ========= */
function flip(i){
  if(G.lock || G.deck[i].matched || G.first===i) return;
  const tiles=$('#board').children;
  tiles[i].classList.add('flip'); AudioFX.flipOpen();
  if(G.first==null){ G.first=i; setHint('Escolha outra carta ğŸ‘€'); return; }
  G.second=i; G.lock=true; G.moves++; $('#moves').textContent=G.moves; updateScore();
  const a=G.deck[G.first], b=G.deck[G.second];
  if(a.key===b.key){
    a.matched=b.matched=true; G.pairs++; $('#pairs').textContent=G.pairs; AudioFX.match(); updateScore();
    setTimeout(()=>{ 
      setHint('VocÃª acertou, parabÃ©ns! ğŸ‰'); 
      G.first=null; G.second=null; G.lock=false;
      buildBoard();
      if(G.pairs===totalPairs()) return win(); 
      setTimeout(()=>setHint('Escolha uma carta ğŸ‘€'), 450); 
    }, 250);
  }else{
    const closeDelay = G.fastFlip ? 420 : 700;
    setTimeout(()=>{ tiles[G.first].classList.remove('flip'); tiles[G.second].classList.remove('flip'); AudioFX.flipClose();
      setHint('VocÃª errou, tente novamente! ğŸ™„'); G.first=null; G.second=null; G.lock=false; setTimeout(()=>setHint('Escolha uma carta ğŸ‘€'), 700); }, closeDelay);
  }
}

/* ========= win ========= */
function win(){
  stopTimer(); stopEventLoop(); AudioFX.victory();
  $('#wTime').textContent=fmtTime(G.sec); $('#wMoves').textContent=G.moves; $('#wPairs').textContent=G.pairs; $('#wScore').textContent=G.score;
  const ov=$('#overlayWin'); ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
}

/* ========= eventos ========= */
function stopEventLoop(){ if(eventTimer){ clearInterval(eventTimer); eventTimer=null } }
function scheduleNextEvent(isFirst=false){
  const base = rand(RULES.eventMin, RULES.eventMax);
  const t = clamp(base + rand(-RULES.jitter, RULES.jitter), RULES.eventMin-10, RULES.eventMax+10);
  eventTargetSec = t; eventElapsed = 0;
  updateEventFill(0, isFirst? '#lobbyEventFill' : '#gameEventFill');
  if(eventTimer) clearInterval(eventTimer);
  eventTimer = setInterval(()=>{ eventElapsed += .2; const p = Math.min(100, (eventElapsed / eventTargetSec) * 100);
    updateEventFill(p, '#gameEventFill'); if(p>=100){ clearInterval(eventTimer); eventTimer=null; triggerEvent(); } }, 200);
}
function updateEventFill(p, sel){ const el=$(sel); if(el) el.style.width=p+'%'; }
function pickEvent(){ const pool = RULES.events.filter(e=>e.key!==lastEvent); const sum = pool.reduce((s,e)=>s+e.weight,0);
  let r=Math.random()*sum; for(const e of pool){ if((r-=e.weight)<=0) return e; } return pool[0]; }
function showEventOverlay(title, desc, onGo){
  $('#eventTitle').textContent = title; $('#eventDesc').textContent  = desc;
  const ov = $('#eventOverlay'); ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
  const go = ()=>{ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); $('#eventGo').removeEventListener('click',go); onGo && onGo(); };
  $('#eventGo').addEventListener('click', go);
}
function triggerEvent(){
  if(G.mode==='easy'){ return; }
  if(eventsFired>=RULES.maxPerGame){ scheduleNextEvent(); return; }
  const ev = pickEvent(); lastEvent = ev.key; eventsFired++;
  const card = $('#gameCard');

  switch(ev.key){
    case 'blackout':
      showEventOverlay('âš ï¸ Blackout!', 'Tudo escurece por alguns segundosâ€¦', ()=>{
        G.lock = true;
        card.classList.add('blackout');
        setTimeout(()=>{ card.classList.remove('blackout'); G.lock = false; scheduleNextEvent(); }, ev.duration*1000);
      }); 
      break;

    case 'invert_board':
      showEventOverlay('âš ï¸ Mundo de cabeÃ§a pra baixo', `O tabuleiro fica invertido por ${ev.duration|0}s!`, ()=>{
        card.classList.add('inverted'); setHint('Calma! O tabuleiro estÃ¡ invertido ğŸ”„');
        setTimeout(()=>{ card.classList.remove('inverted'); setHint('Escolha uma carta ğŸ‘€'); scheduleNextEvent(); }, ev.duration*1000);
      }); 
      break;

    case 'shuffle_unmatched':
      showEventOverlay('âš ï¸ Embaralhar!', 'Cartas nÃ£o resolvidas trocam de lugar!', ()=>{
        G.lock = true;
        shuffleUnmatchedSafe();
        buildBoard();
        G.first = G.second = null;
        G.lock = false;
        scheduleNextEvent();
      }); 
      break;

    case 'recolor_board':
      showEventOverlay('âš ï¸ Preto & branco', 'Tudo fica P&B por alguns segundos!', ()=>{
        card.classList.add('bw-mode');
        setTimeout(()=>{ card.classList.remove('bw-mode'); scheduleNextEvent(); }, ev.duration*1000);
      }); 
      break;

    case 'reveal_partial':
      showEventOverlay('âš ï¸ VisÃ£o RÃ¡pida', `Algumas cartas serÃ£o reveladas por ${ev.duration|0}s!`, ()=>{
        partialReveal(RULES.bonusCoverage, ev.duration);
        setTimeout(()=>{ scheduleNextEvent(); }, ev.duration*1000);
      }); 
      break;
  }
}

/* ======= helpers de evento ======= */
function shuffleUnmatchedSafe(){
  const idxs = [...G.deck.keys()].filter(i=>!G.deck[i].matched);
  const cards = idxs.map(i=>G.deck[i]);
  shuffle(cards);
  idxs.forEach((pos,k)=>{ G.deck[pos] = cards[k]; });
}
function partialReveal(rate=0.3, seconds=5){
  const openIdx = [], tiles = $('#board').children, unmatched = [...G.deck.keys()].filter(i=>!G.deck[i].matched); shuffle(unmatched);
  const showN = Math.max(1, Math.floor(unmatched.length*rate));
  for(let i=0;i<showN;i++){ const k=unmatched[i]; tiles[k].classList.add('flip'); openIdx.push(k); }
  setTimeout(()=>{ openIdx.forEach(i=>tiles[i].classList.remove('flip')); }, seconds*1000);
}

/* === escolher N pares nÃ£o resolvidos === */
function pickUnmatchedPairs(countPairs=3) {
  const buckets = new Map(); // key -> [idx, idx]
  G.deck.forEach((card, idx) => {
    if (!card.matched) {
      if (!buckets.has(card.key)) buckets.set(card.key, []);
      buckets.get(card.key).push(idx);
    }
  });
  const completePairs = [...buckets.values()].filter(list => list.length === 2);
  for (let i = completePairs.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [completePairs[i], completePairs[j]] = [completePairs[j], completePairs[i]]; }
  return completePairs.slice(0, countPairs).flat();
}

/* ========= botÃ£o Revelar (5s, uma vez) â€” 3 pares ========= */
function revealAllOnce() {
  if (G.revealUsed) return;

  const btn = $('#btnReveal');
  const tiles = $('#board').children;

  const showIdx = pickUnmatchedPairs(3);

  if (showIdx.length === 0) {
    G.revealUsed = true;
    btn.disabled = true;
    btn.textContent = 'VocÃª nÃ£o pode mais usar, boa sorte! ğŸ‘€';
    return;
  }

  G.revealUsed = true;
  btn.disabled = true;
  btn.textContent = 'VocÃª nÃ£o pode mais usar, boa sorte! ğŸ‘€';

  const alreadyOpen = new Set(
    [...tiles].map((t, i) => t.classList.contains('flip') ? i : -1).filter(i => i >= 0)
  );

  showIdx.forEach(i => tiles[i].classList.add('flip'));
  setHint('Dica bÃ´nus! ğŸ‘€');

  setTimeout(() => {
    showIdx.forEach(i => {
      if (!alreadyOpen.has(i) && !G.deck[i].matched) {
        tiles[i].classList.remove('flip');
      }
    });
    setHint('Escolha uma carta ğŸ‘€');
  }, (G.mode==='easy'? RULES_EASY.bonusRevealSeconds : RULES.bonusRevealSeconds) * 1000);
}

/* ========= routing ========= */
function go(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $('#screen-'+id)?.classList.add('active'); }

/* ========= bindings ========= */
$('#btnPlay').onclick = ()=>{ AudioFX.click(); newGame('normal'); };
$('#btnPlayEasy').onclick = ()=>{ AudioFX.click(); newGame('easy'); };

$('#btnBackInGame').onclick = ()=>{ AudioFX.click(); backToLobby(); };
$('#btnPlayAgain').onclick = ()=>{ AudioFX.click(); $('#overlayWin').classList.remove('show'); newGame(G?.mode || 'normal'); };
$('#btnBackFromWin').onclick = ()=>{ AudioFX.click(); $('#overlayWin').classList.remove('show'); backToLobby(); };

$('#btnToggleSound').onclick = ()=>{ AudioFX.click(); AudioFX.toggleSound(); };
$('#btnToggleSoundGame').onclick = ()=>{ AudioFX.click(); AudioFX.toggleSound(); };

$('#volumeSlider').oninput = e=>{ AudioFX.setVolume(e.target.value/100); syncSoundButtons(); };
$('#volumeSliderGame').oninput = e=>{ AudioFX.setVolume(e.target.value/100); syncSoundButtons(); };

$('#btnReveal').onclick = ()=>{ AudioFX.click(); revealAllOnce(); };

/* ========= init ========= */
window.addEventListener('load', ()=>{
  AudioFX.init();
  if(AudioFX.ctx.state==='suspended'){
    const resume=()=>{ AudioFX.ctx.resume(); document.removeEventListener('click',resume); };
    document.addEventListener('click',resume,{once:true});
  }
  syncSoundButtons();
  let p=0; setInterval(()=>{ p=(p+1)%101; $('#lobbyEventFill').style.width=p+'%'; },120);
});
</script>
</body>
</html>
